<!DOCTYPE html>
<html>
<head>
  <script src="ftl-js-core.js"></script>
  <script src="ftl-js-parser.js"></script>
    
  <script id='module:ftl.lang' type='application/ftl'>module ftl.lang

//
// basic arithmetic operators
//

// unary -
//fn -(val) { return -val }

fn x + y { return x + y }


fn x - y { return x - y }
fn x * y { return x * y }
fn x / y { return x / y }
fn x % y { return x % y }

//
// basic logic operators
//
fn x == y {
  function arrayIdentical(a, b) {
    var i = a.length;
    if (i != b.length) return false;
    while (i--) {
        if (a[i] != b[i]) return false;
    }
    return true;
  }
  return x == y || x instanceof Array && y instanceof Array && arrayIdentical(x, y)
  || x instanceof ftl.Tuple && x.equals(y) }

fn x != y { return x != y }
fn x < y { return x < y }
fn x <= y { return x <= y }
fn x > y { return x > y }
fn x >= y { return x >= y }
fn x || y$() { return x || y() }
fn x && y$() { return x && y() }

// basic math functions
fn sin(x) { return Math.sin(x) }
fn cos(x) { return Math.cos(x) }

// ternary operator with if_true and otherwise marked as tail functions
fn condition ? if_true() : otherwise() { return condition ? if_true() : otherwise() }

// ternary operator with if_true and otherwise marked as tail functions
fn condition ?? if_true$() :: otherwise$() { return condition ? if_true() : otherwise() }

// factorial
fn x! -> x < 2 ?? 1 :: (((x - 1)!) * x)

//
// tuple functions
//

// operator '.' for sub-element resolution
//fn a . b(raw) ->  b(a)

//
// list functions
//

// length of list
fn len(list) {
  return list.length;
}

// append item to list and return
fn list += item {
  list.push(item);
  return list;
}

// internal map
fn _map(src, mapped, index, mapper) -> index == len(src) ?? mapped :: _map(src, mapped += mapper(src[index]), index + 1, mapper)

// map operator that returns a new list with list element mapped with mapper function
fn list => mapper(item) -> _map(list, [], 0, mapper)

// internal reduce
fn _reduce(accu, list, index, reducer) -> index == len(list) ?? accu :: _reduce(reducer(accu, list[index]), list, index + 1, reducer)

// reduce operator that returns reduced from list with reducer function
fn list =>. reducer(i1, i2) -> _reduce(list[0], list, 1, reducer)

// internal filter
fn _filter(list, filtered, index, predicate) ->
 index == len(list) ? filtered : _filter(list, (list[index], predicate, filtered) -> _1(_0) ?? (_2 += _0) :: _2, index + 1, predicate)

// filter operator
fn list =>| predicate(item) -> _filter(list, [], 0, predicate)
</script>

<script id='module:unit.test' type='application/ftl'>import ftl.lang.*

fn square_area(x, y) {

  // module.get('==').apply(1, 2);
  return x * y;
}

// basic types
1 == 1
"Hello, ftl!" == 'Hello, ftl!'
3.14159 == 3.14159
true == true
false == false
[] == []
[1, 2, 3.14159, 'hello'] == [1, 2, 3.14159, 'hello']

// array selector
[1, 2, 3.14159, 'hello'] -> _0[2] == 3.14159
[1, 2, 3.14159, 'hello'] -> (_[1], _[0]) == (2 ,1)

// tuple equality
1 == (1)
(1) == 1
(-1) == -1
(1, 2, 3) == (1, 2, 3)
((1, 2), 3) == ((1, 2), 3)
(a:(b:1, c:2), d:3) == ((1, 2), 3)

// logic operation
(1 > 2) || (2 > 1) == true
(2 > 1) || (1 > 2) == true
(3 > 2) && (2 > 1) == true
(1 > 2) && (2 > 1) == false

// special operators
(5!) == 120

fn test1(x) -> false
fn test2(x) -> true

(1 -> test1 || test2) == true
(1 -> (_0 -> false) || (_0 -> true)) == true

// arithmetic
1 + 2 + (3 * 4) == 15
"a" + "b" + "c" == 'abc'
'a' + 'b' + 'c' == "abc"
square_area(2, 3) == 6
((2, 3) -> square_area) == 6

// expr fn
((_0, _1) -> _0 + _1)(1, 2) == 3
((x:_0, y:_1) -> x + y)(1, 2) == 3

// lambda
(1, 2) -> $(x, y) -> x + y == 3
2 -> $(x, y:3) -> x + y == 5

// default parameter value
(2, 4) -> $(x, y:3) -> x + y == 6

// passing named value
(2, y:4) -> $(x, y:3) -> x + y == 6
(2, y:0) -> $(x, y:3) -> x + y == 2

// test tail in oeprator
fn x ||| y$() { return x || y() }
(false, true) -> _0 ||| _1

// test tail in function
fn test_tail(x, y$()) {
  return x || y()
}

(false, true) -> test_tail(_0, _1)

// test functional
// functional

//map
(4, 5) -> [1, 2, 3] => (_1 + item + 2) == [8, 9, 10]

// reduce
[1, 2, 3] =>. (i1 + i2) == 6

// filter
[-1, 2, 5, 8, -2] =>| (item < 0) == [-1, -2]

fn _is_prime(n, divisor:2) -> (divisor == (n - 1)) ? true : ((n % divisor == 0) ? false : _is_prime(n, divisor + 1))

// test if a number is a prime number
fn is_prime(n) -> (n < 2) ?? false :: ((n == 2) ?? true :: _is_prime(n))

// apply is_prime to 31 to test if 31 is a prime number
is_prime(31) == true

is_prime(32) == false

// ======== n-ary  w/o operator precedence

// ternary operator
fn a - b - c {
  return a - b - c
}

// quadruple operator
fn a - b + c - d {
  return a - b + c - d
}

// the following is equivalent to (1 - 2 + 4 - 9) + (4 - 5 - 7) 
1 - 2 + 4 - 9 + 4 - 5 - 7 == -14

// ======== partial function
fn contains(str, sub) {
  return str.includes(sub);
}

'this is a test' -> contains(sub:'test')

// ======== exceptions

// same name more than once
// (a:1, a:2)

// more than one empty argument list
// square_area()() == 6

// empty argument list when at least one argument is needed for curry
// square_area() == 6
</script>

<script>
function init() {
  var ftl_lang = document.getElementById('module:ftl.lang').text;
  try {
    var module = ftl.parser.parse(ftl_lang);
    ftl.addModule(module.name, module);
    console.log('ftl.lang loaded');
  } catch (e) {
    out_area.value = e.message;
    console.trace(e);
  }
}

function load() {
  ftl.validateBuild(true);
  var ftl_code = document.getElementById('module:unit.test').text;
  var code_area = document.getElementById('code-area');
  code_area.value = ftl_code;

  init();
}

function run_test() {
  var out_area = document.getElementById('out_area');
  out_area.value = '';

  try {
    var code_area = document.getElementById('code-area');
    var module = ftl.parser.parse(code_area.value);

    var i = 1;
    module.executables.forEach(function(exec) {
      out_area.value += i++ + '. ';
      out_area.value += (exec instanceof ftl.TupleFn || exec.constructor.name == 'Fn' ? 'tuple' : exec.toString()) + ' => '
      var res = exec.apply(null, context=module);
      if (typeof(res) != 'undefined' && res instanceof ftl.TailFn) {
        res = res.apply();
      }
      if (typeof(res) != 'undefined') {
        if (res instanceof ftl.RefFn) {
          out_area.value += 'reference ' + res.name + ' undefined\r\n';
        } else if (Array.isArray(res) || typeof res == 'string') {
          out_area.value += JSON.stringify(res) + '\r\n';
        } else
          out_area.value += res + '\r\n';
      }
    });
  } catch (e) {
    if (e.stack)
      console.log(e.stack);
    out_area.value += e.message;
  }
}
</script>
</head>
<body onload="load()">
  <textarea id='code-area' style='width:800px;height:400px'>
  </textarea>
  <div>
    <button onclick='run_test()'>Run</button>
  </div>
  <textarea id='out_area' style='width:800px; height:200px; margin-top:20px'>
  </textarea>
</body>